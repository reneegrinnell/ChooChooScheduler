<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Choo-Choo Scheduler</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <!-- Firebase Reference -->
    <script src="https://www.gstatic.com/firebasejs/5.5.0/firebase.js"></script>

    <!-- Moment.js Reference -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
</head>

<body>

    <div class="container">

        <!-- Jumbotron -->
        <div class="jumbotron">
            <h1 class="text-center">Choo-Choo Scheduler</h1>
            <h4 class="text-center">I Think I Can, I Think I Can...</h4>
        </div>

        <div class="row">

            <!-- Wells for displaying all users -->
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5><strong>All Choo-Choos</strong></h5>
                    </div>
                    <div class="card-body">
                        <table class="table" id="trains">
                            <thead>
                                <th>Train Name</th>
                                <th>Destination</th>
                                <th>Frequency (min)</th>
                                <th>Next Arrival</th>
                                <th>Minutes Away</th>
                            </thead>
                            <tbody id="fullTrainList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Train info card-->
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5><strong>Add a Choo-Choo</strong></h5>
                    </div>

                    <div class="card-body">

                        <!-- Train data entry form-->
                        <form role="form">
                            <div class="form-group row">
                                <label for="trainName-input">Train Name</label>
                                <input class="form-control" id="trainName-input" type="text">
                            </div>
                            <div class="form-group row">
                                <label for="trainDestination-input">Destination</label>
                                <input class="form-control" id="trainDestination-input" type="text">
                            </div>
                            <div class="form-group row">
                                <label for="firstTrainTime-input">Time of First Train (HH:mm, military time)</label>
                                <input class="form-control" id="firstTrainTime-input" type="text">
                            </div>
                            <div class="form-group row">
                                <label for="trainFrequency-input">Arrival Frequency (min)</label>
                                <input class="form-control" id="trainFrequency-input" type="text"></textarea>
                            </div>
                            <button class="btn btn-default" id="addTrain" type="submit">Submit this Choo-Choo</button>
                        </form>

                    </div>
                </div>
            </div>

            <footer>&copy; Ren√©e Grinnell 2018</footer>

        </div>

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery.js"></script>

        <script>

            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyAruY3ZVHowNtJPL4tUm-V0ZJzhgLjSFYU",
                authDomain: "choochooscheduler-e209a.firebaseapp.com",
                databaseURL: "https://choochooscheduler-e209a.firebaseio.com",
                projectId: "choochooscheduler-e209a",
                storageBucket: "choochooscheduler-e209a.appspot.com",
                messagingSenderId: "1070793801761"
            };

            firebase.initializeApp(config);

            var dataRef = firebase.database();

            // Initial values
            var trainName = "";
            var trainDestination = "";
            var firstTrainTime = 0;
            var trainFrequency = 0;

            // Capture button click
            $("#add-user").on("click", function (event) {
                event.preventDefault();

                // Logic for storing/retrieving most recent train
                trainName = $("#trainName-input").val().trim();
                trainDestination = $("#trainDestination-input").val().trim();
                firstTrainTime = $("#firstTrainTime-input").val().trim();
                trainFrequency = $("#trainFrequency-input").val().trim();

                // Pushing info for most recent train to Firebase
                dataRef.ref().push({

                    trainName: trainName,
                    trainDestination: trainDestination,
                    firstTrainTime: firstTrainTime,
                    trainFrequency: trainFrequency,
                    dateAdded: firebase.database.ServerValue.TIMESTAMP
                });
            });

            // Firebase watcher + initial loader
            dataRef.ref().on("child_added", function (childSnapshot) {

                // Log everything that's coming out of snapshot
                console.log(childSnapshot.val().trainName);
                console.log(childSnapshot.val().trainDestination);
                console.log(childSnapshot.val().firstTrainTime);
                console.log(childSnapshot.val().trainFrequency);
                console.log(childSnapshot.val().joinDate);

                // Full list of items to the well
                $("#fullTrainList").append("<div class='well'><span class='nameOfTrain'> " +
                    childSnapshot.val().trainName +
                    " </span><span class='destinationOfTrain'> " + childSnapshot.val().trainDestination +
                    " </span><span class='timeOfFirstTrain'> " + childSnapshot.val().firstTrainTime +
                    " </span><span class='frequencyOfTrain'> " + childSnapshot.val().trainFrequency +
                    " </span></div>");

                // Handle errors
            }, function (errorObject) {
                console.log("Errors handled: " + errorObject.code);
            });

            dataRef.ref().orderByChild("dateAdded").limitToLast(1).on("child_added", function (snapshot) {
                // Change HTML to reflect
                $("#nameOfTrain").text(snapshot.val().trainName);
                $("#destinationOfTrain").text(snapshot.val().trainDestination);
                $("#timeOfFirstTrain").text(snapshot.val().firstTrainTime);
                $("#frequencyOfTrain").text(snapshot.val().trainFrequency);
            });

        </script>
</body>

</html>